
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SRBCSS - Professores</title>
<style>
  :root{
    --bg:#0e1625; --card:#14213b; --line:#2b3f66;
    --text:#f8fafc; --muted:#cbd5e1;
    --pri:#6d28d9; --ok:#10b981; --err:#ef4444; --warn:#f59e0b;
    --chip:#0b1220; --chipHover:#0f1a2e; --chipSel:#1e293b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .wrap{max-width:1024px;margin:20px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px}
  h1{margin:0 0 6px;font-size:1.45rem}
  .muted{color:var(--muted)}
  .grid-info{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0 6px}
  @media (max-width:720px){.grid-info{grid-template-columns:1fr}}
  .info{background:rgba(0,0,0,.18);border:1px solid var(--line);border-radius:12px;padding:12px}
  .info b{display:block;margin-bottom:4px;color:#e2e8f0}
  .section{margin:18px 0 8px;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:rgba(0,0,0,.18);font-weight:700}
  .item{border:1px solid var(--line);border-radius:12px;padding:12px;background:rgba(0,0,0,.18);margin-bottom:12px}
  .stem{font-size:1rem;margin-bottom:10px}
  .scale{display:grid;grid-template-columns:repeat(3,minmax(200px,1fr));gap:10px}
  @media (max-width:820px){ .scale{grid-template-columns:1fr} }
  .opt{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:var(--chip);cursor:pointer;transition:background .15s,border-color .15s,transform .05s}
  .opt:hover{background:var(--chipHover);border-color:#4f70ff;transform:translateY(-1px)}
  .opt input{appearance:none;-webkit-appearance:none;width:0;height:0;position:absolute;opacity:0}
  .opt span{font-weight:600}
  .opt small{opacity:.8}
  .opt:has(input:checked){background:var(--chipSel);border-color:#6d28d9;box-shadow:0 0 0 1px #6d28d9 inset}
  .legend{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 12px}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.25);font-size:.86rem}
  .btn{display:inline-flex;align-items:center;gap:10px;background:var(--pri);border:none;color:#fff;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:600}
  .btn.ok{background:var(--ok)}
  .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--muted)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .msg{margin:12px 0;padding:12px;border-radius:10px}
  .okbox{background:#06351f;border:1px solid #0e6c45;color:#c8ffe3}
  .errbox{background:#3b0d0d;border:1px solid #7f1d1d;color:#ffd5d5}
  .warnbox{background:#3a2903;border:1px solid #885e09;color:#ffe6b0}
  .progress{height:10px;background:rgba(255,255,255,.05);border:1px solid var(--line);border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,#6d28d9,#10b981)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Escala de Características Comportamentais para Crianças Superdotadas - Professores</h1>
    <p class="muted">
    As respostas serão enviadas diretamente para a profissional responsável.  
    </p>

    

    <div id="pacInfo" class="grid-info" style="display:none;"></div>

    <div id="progressWrap" style="display:none;gap:8px;align-items:center;margin:8px 0 0;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px">
        <span class="muted" id="progressText">Progresso: 0/0</span>
        <button id="clearDraft" class="btn ghost" type="button">Limpar rascunho</button>
      </div>
      <div class="progress"><div class="bar" id="bar"></div></div>
    </div>

    <form id="form" style="margin-top:14px;display:none" novalidate>
      <div id="qs"></div>
      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
        <button id="btnSubmit" class="btn ok" type="submit">Enviar respostas</button>
        <button id="btnSave" class="btn ghost" type="button">Salvar rascunho</button>
      </div>
      <div id="msg" class="msg" style="display:none" role="alert" aria-live="polite"></div>
    </form>

    <div id="alert" class="msg" style="display:none" role="alert" aria-live="assertive"></div>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = { PATIENTS:"Patients", TOKENS:"LinkTokens", SCORES:"Scores_SRBCSS_PROFESSORES" };
const CODE = "SRBCSS_PROFESSORES";
const PORTAL_URL = "https://integradaneuropsicologia.github.io/formularios/";
const RELEASE_KEYS = ["SRBCSS_PROFESSORES"]; // coluna(s) de liberação no Patients, com valor "sim"

/* ========= HELPERS ========= */
const $ = s => document.querySelector(s);
const onlyDigits = s => (s||"").replace(/\D+/g,"");
const qs = k => new URLSearchParams(location.search).get(k) || "";
function setBox(id, text, kind="ok"){ const el=$(id); if(!el) return; el.textContent=text; el.className="msg "+(kind==="ok"?"okbox":kind==="warn"?"warnbox":"errbox"); el.style.display="block"; }
function hideBox(id){ const el=$(id); if(!el) return; el.style.display="none"; el.textContent=""; }
function maskCPF(cpf){ const d=onlyDigits(cpf||""); if(d.length!==11) return cpf||""; return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`; }
function fmtDateISO(iso){ if(!iso) return ""; const [y,m,d]=String(iso).split("-"); return (y&&m&&d)?`${d}/${m}/${y}`:iso; }
async function GET(url){ const r=await fetch(url); if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); }
async function sheetSearch(sheet, params){ const usp=new URLSearchParams(params); return GET(`${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`); }
async function sheetCreate(sheet, row){ const r=await fetch(`${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`,{method:"POST",headers:{ "Content-Type":"application/json" },body:JSON.stringify({data:[row]})}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
async function sheetPatchBy(sheet, column, value, data){ const r=await fetch(`${SHEETDB_BASE}/${encodeURIComponent(column)}/${encodeURIComponent(value)}?sheet=${encodeURIComponent(sheet)}`,{method:"PATCH",headers:{ "Content-Type":"application/json" },body:JSON.stringify({data})}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
const TOKEN = qs("token");
function goPortalWithToken(){
  try{ const u=new URL(PORTAL_URL,location.href); if(TOKEN) u.searchParams.set("token",TOKEN); location.href=u.toString(); }
  catch(_){ const sep=PORTAL_URL.includes("?")?"&":"?"; location.href=PORTAL_URL+(TOKEN?sep+"token="+encodeURIComponent(TOKEN):""); }
}

/* ========= DOMÍNIOS E ITENS ========= */
const DOMAINS = [
  {
    key:"APRENDIZAGEM",
    label:" Habilidades de Aprendizagem",
    items: [
      "Compreende rapidamente novas informações e conteúdos.",
      "Apresenta interesse em temas que vão além do currículo esperado para a idade.",
      "Utiliza estratégias de aprendizagem avançadas para entender conceitos complexos.",
      "Demonstra facilidade para generalizar conceitos e aplicá-los em diferentes contextos.",
      "Realiza perguntas complexas e busca entender os fundamentos dos conceitos apresentados.",
      "Aprende de forma independente e explora temas de maneira autodidata.",
      "Demonstra raciocínio lógico e facilidade em conectar ideias aparentemente desconexas.",
      "Faz inferências e formula hipóteses com base nas informações apresentadas."
    ]
  },
  {
    key:"MOTIVACAO",
    label:"Motivação",
    items: [
      "Continua a trabalhar em uma tarefa mesmo diante de dificuldades.",
      "Demonstra entusiasmo em aprender e explorar novos tópicos.",
      "Apresenta iniciativa para realizar projetos ou atividades por conta própria.",
      "Dedica-se a melhorar suas habilidades, buscando excelência em suas atividades.",
      "Participa ativamente de discussões e demonstra interesse genuíno em aprender.",
      "Define metas pessoais para alcançar e supera expectativas com frequência.",
      "Mostra perseverança e empenho ao lidar com atividades desafiadoras."
    ]
  },
  {
    key:"CRIATIVIDADE",
    label:"Criatividade ",
    items: [
      "Gera ideias novas e originais para resolver problemas.",
      "Propõe soluções inesperadas e inovadoras para desafios cotidianos.",
      "Combina informações de diferentes áreas para criar novas perspectivas.",
      "Demonstra curiosidade e interesse em explorar novas possibilidades.",
      "Encontra novas maneiras de abordar tarefas e atividades comuns.",
      "Produz trabalhos criativos e inovadores em diferentes áreas (desenhos, escrita, projetos, etc.).",
      "Aprecia a ambiguidade e demonstra facilidade em lidar com situações abertas."
    ]
  },
  {
    key:"LIDERANCA",
    label:"Liderança",
    items: [
      "Inicia e organiza atividades em grupo.",
      "Demonstra responsabilidade e capacidade de tomar decisões de maneira eficaz.",
      "Inspira e motiva os outros a participarem e se engajarem em atividades.",
      "Resolve conflitos de maneira pacífica e justa, buscando o consenso.",
      "Comunica suas ideias de maneira clara e assertiva.",
      "Assume a responsabilidade pelo grupo e organiza tarefas.",
      "Gosta de participar de atividades que envolvem responsabilidade e liderança."
    ]
  }
];

/* ========= RENDER ========= */
function renderQuestions(){
  const host=$("#qs"); host.innerHTML="";
  let count=0;

  DOMAINS.forEach(domain=>{
    const sec=document.createElement('div');
    sec.className='section';
    sec.textContent=domain.label;
    host.appendChild(sec);

    domain.items.forEach(txt=>{
      count++;
      const qn=String(count).padStart(3,'0');

      const row=document.createElement('div');
      row.className='item';
      row.setAttribute('data-q',String(count));

      const stem=document.createElement('div');
      stem.className='stem';
      stem.id=`s${qn}`;
      stem.textContent = `${count}. ${txt}`;

      const scale=document.createElement('div'); scale.className='scale';
      const CHOICES=[
        {v:1,l:'Nunca'},
        {v:2,l:'Raramente'},
        {v:3,l:'Às vezes'},
        {v:4,l:'Frequentemente'},
        {v:5,l:'Sempre'}
      ];
      CHOICES.forEach(c=>{
        const lab=document.createElement('label'); lab.className='opt'; lab.title=`${c.l} (${c.v})`;
        const id=`q${qn}_${c.v}`;
        lab.innerHTML=`<input type="radio" name="q${qn}" id="${id}" value="${c.v}" required aria-labelledby="s${qn}"><span>${c.l}</span><small></small>`;
        scale.appendChild(lab);
      });

      row.append(stem,scale);
      host.appendChild(row);
    });
  });

  // Atualiza total para progresso
  $("#progressText").textContent = `Progresso: 0/${count}`;
}

/* ========= ESTADO ========= */
let patient=null, tokenRow=null, CPF="";
const STORAGE_KEY = `SRBCSS_PROFESSORES_${qs("token")||"anon"}`;

/* ========= BOOT ========= */
(async function boot(){
  try{
    if(!TOKEN){ setBox("#alert","Link inválido (sem token). Solicite um novo link.","err"); return; }

    const trows=await sheetSearch(SHEETS.TOKENS,{token:TOKEN});
    if(!trows.length) throw new Error("Token inválido ou expirado.");
    tokenRow=trows[0];
    if(String(tokenRow.disabled||"não").toLowerCase()==="sim") throw new Error("Token desativado.");
    if(tokenRow.expires_at && new Date(tokenRow.expires_at) < new Date()) throw new Error("Token expirado.");
    CPF=onlyDigits(tokenRow.cpf||"");
    if(!CPF) throw new Error("Token sem CPF vinculado.");

    const prows=await sheetSearch(SHEETS.PATIENTS,{cpf:CPF});
    if(!prows.length) throw new Error("Paciente não encontrado.");
    patient=prows[0];

    const isAllowed = RELEASE_KEYS.some(k => String(patient[k]||"").trim().toLowerCase()==="sim");
    if(!isAllowed){ setBox("#alert","Este formulário não está liberado para você.","err"); return; }

    // Já respondeu?
    const already=await sheetSearch(SHEETS.SCORES,{cpf:CPF,code:CODE});
    const doneKeys=RELEASE_KEYS.map(k=>`${k}_FEITO`);
    const anyDoneFlag=doneKeys.some(k=>String(patient[k]||"").trim().toLowerCase()==="sim");
    if(anyDoneFlag || (already && already.length)){
      setBox("#alert","Você já respondeu este formulário. Voltando ao portal…","ok");
      setTimeout(goPortalWithToken,1200); return;
    }

    renderPatientInfo();
    renderQuestions();
    restoreDraft(); updateProgress();

    $("#pacInfo").style.display="grid";
    $("#form").style.display="block";
    $("#progressWrap").style.display="block";
    hideBox("#alert");
  }catch(err){
    console.error(err);
    setBox("#alert", err.message || "Falha ao abrir o formulário.", "err");
  }
})();

function renderPatientInfo(){
  const g=$("#pacInfo"); g.innerHTML="";
  const info=[
    ["Nome", patient.nome||"-"],
    ["Nascimento", fmtDateISO(patient.data_nascimento)]
  ];

  for(const [k,v] of info){
    const div=document.createElement("div");
    div.className="info";
    div.innerHTML=`<b>${k}</b><div>${v||"-"}</div>`;
    g.appendChild(div);
  }
}

/* ========= RASCUNHO ========= */
function saveDraft(){
  const data={};
  document.querySelectorAll('input[type="radio"][name^="q"]:checked').forEach(el=>{
    data[el.name]=Number(el.value);
  });
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }catch(_){}
}
function restoreDraft(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY); if(!raw) return;
    const data=JSON.parse(raw||"{}");
    Object.entries(data).forEach(([k,v])=>{
      const el=document.querySelector(`input[name="${k}"][value="${v}"]`);
      if(el) el.checked=true;
    });
  }catch(_){}
}
function clearDraft(){
  try { localStorage.removeItem(STORAGE_KEY); } catch (_) { /* ignore */ }
}
function countTotalItems(){ return DOMAINS.reduce((a,d)=>a+d.items.length,0); }
function countAnswered(){ return document.querySelectorAll('input[type="radio"][name^="q"]:checked').length; }
function updateProgress(){
  const ans=countAnswered(), tot=countTotalItems();
  $("#progressText").textContent=`Progresso: ${ans}/${tot}`;
  $("#bar").style.width=`${(ans/tot)*100}%`;
}

/* ========= EVENTOS ========= */
addEventListener('change', e=>{
  if(e.target && e.target.matches('input[type="radio"][name^="q"]')){ saveDraft(); updateProgress(); }
});
$("#btnSave").addEventListener('click', ()=>{ saveDraft(); setBox("#msg","Rascunho salvo neste dispositivo.","ok"); });
$("#clearDraft").addEventListener('click', ()=>{ clearDraft(); setBox("#msg","Rascunho apagado.","warn"); });

/* ========= CÁLCULOS ========= */
function domainSum(domainIndex){
  // soma valores daquele domínio
  let base=0;
  for(let i=0;i<domainIndex;i++) base += DOMAINS[i].items.length;
  let sum=0;
  for(let j=1;j<=DOMAINS[domainIndex].items.length;j++){
    const qn=String(base+j).padStart(3,'0');
    const sel=document.querySelector(`input[name="q${qn}"]:checked`);
    sum += sel ? Number(sel.value) : 0;
  }
  return sum;
}
function totalSum(){
  let s=0;
  const n=countTotalItems();
  for(let i=1;i<=n;i++){
    const qn=String(i).padStart(3,'0');
    const sel=document.querySelector(`input[name="q${qn}"]:checked`);
    s += sel ? Number(sel.value) : 0;
  }
  return s;
}

/* ========= TEXTO HUMANO DAS RESPOSTAS ========= */
// mapa fixo dos rótulos Likert 1-5 usados nesse instrumento
const LIKERT5 = [
  {v:1,l:'Nunca'},
  {v:2,l:'Raramente'},
  {v:3,l:'Às vezes'},
  {v:4,l:'Frequentemente'},
  {v:5,l:'Sempre'}
];

function labelFromValue(vNum){
  const f = LIKERT5.find(o => o.v === Number(vNum));
  return f ? f.l : String(vNum);
}

function collectQuestionsAnswers(){
  const lines = [];
  let globalIdx = 0;

  DOMAINS.forEach(domain => {
    domain.items.forEach(txt => {
      globalIdx++;
      const qn = String(globalIdx).padStart(3,'0');
      const sel = document.querySelector(`input[name="q${qn}"]:checked`);
      const ansLabel = sel ? labelFromValue(sel.value) : "—";
      lines.push(`${globalIdx}. ${txt} => ${ansLabel}`);
    });
  });

  return lines.join("\n");
}

/* ========= SUBMIT ========= */
let sending=false;
$("#form").addEventListener("submit", async (e)=>{
  e.preventDefault(); if(sending) return; sending=true; hideBox("#msg");
  const btn=$("#btnSubmit"); const t=btn.textContent; btn.disabled=true; btn.textContent="Enviando…";
  try{
    // validação: tudo respondido
    const tot=countTotalItems();
    for(let i=1;i<=tot;i++){
      const qn=String(i).padStart(3,'0');
      if(!document.querySelector(`input[name="q${qn}"]:checked`)){
        const row=document.querySelector(`.item[data-q="${i}"]`);
        if(row) row.scrollIntoView({behavior:'smooth',block:'center'});
        throw new Error(`Responda o item ${i}.`);
      }
    }

    // somatórios por domínio
    const somaAPRENDIZAGEM = domainSum(0);
    const somaMOTIVACAO    = domainSum(1);
    const somaCRIATIVIDADE = domainSum(2);
    const somaLIDERANCA    = domainSum(3);
    const somaINTERPRETACAO = totalSum(); // soma geral

    // máximo possível (itens * 5 pontos)
    const maxTotal = countTotalItems() * 5;

    // cortes de interpretação por domínio
    function aprendizagem(s){
      if(s>=32) return "Habilidade Excelente.";
      if(s>=24) return "Habilidade Alta.";
      if(s>=16) return "Habilidade Média.";
      return "Habilidade Baixa.";
    }
    function motivacao(s){
      if(s>=28) return "Habilidade Excelente.";
      if(s>=21) return "Habilidade Alta.";
      if(s>=14) return "Habilidade Média.";
      return "Habilidade Baixa.";
    }
    function criatividade(s){
      if(s>=28) return "Habilidade Excelente.";
      if(s>=21) return "Habilidade Alta.";
      if(s>=14) return "Habilidade Média.";
      return "Habilidade Baixa.";
    }
    function lideranca(s){
      if(s>=28) return "Habilidade Excelente.";
      if(s>=21) return "Habilidade Alta.";
      if(s>=14) return "Habilidade Média.";
      return "Habilidade Baixa.";
    }

    // interpretação global proporcional
    function interpretacao(s){
      const p = s / maxTotal; // 0..1
      if (p >= 0.80) return "Perfil de superdotação bem desenvolvido, com alta probabilidade de desempenho excepcional em várias áreas.";
      if (p >= 0.60) return "Perfil cognitivo e comportamental superior, com destaque em algumas dimensões específicas.";
      if (p >= 0.40) return "Desenvolvimento dentro do esperado, com algumas áreas de potencial elevado.";
      return "Dificuldades no desenvolvimento de algumas áreas, necessitando acompanhamento mais detalhado para apoio e estímulo adicional.";
    }

    // texto interpretativo compacto
    const categoria_csv = [
      `Aprendizagem=${aprendizagem(somaAPRENDIZAGEM)}`,
      `Motivação=${motivacao(somaMOTIVACAO)}`,
      `Criatividade=${criatividade(somaCRIATIVIDADE)}`,
      `Liderança=${lideranca(somaLIDERANCA)}`,
      `Interpretação=${interpretacao(somaINTERPRETACAO)}`
    ].join(',');

    // bloco completo "pergunta => resposta"
    const questionsStr = collectQuestionsAnswers();

    // envia
    await sheetCreate(SHEETS.SCORES, {
      result_id: `${patient.cpf}_${CODE}_${Date.now()}`,
      token: TOKEN,
      cpf: patient.cpf,
      code: CODE,
      source: "professor",
      submitted_at: new Date().toISOString(),
      total: somaINTERPRETACAO,
      categoria: categoria_csv,
      metrics: JSON.stringify({
        sums: {
          APRENDIZAGEM: somaAPRENDIZAGEM,
          MOTIVACAO: somaMOTIVACAO,
          CRIATIVIDADE: somaCRIATIVIDADE,
          LIDERANCA: somaLIDERANCA
        },
        total: somaINTERPRETACAO,
        max_total: maxTotal,
        percent_total: Number((somaINTERPRETACAO / maxTotal).toFixed(4))
      }),
      questions: questionsStr   // << audit trail das respostas
    });

    // marca como feito
    const patch={};
    RELEASE_KEYS.map(k=>`${k}_FEITO`).forEach(k=>{ if(k in patient) patch[k]="sim"; });
    if(Object.keys(patch).length===0) patch[`${RELEASE_KEYS[0]}_FEITO`] = "sim";
    await sheetPatchBy(SHEETS.PATIENTS,"cpf",patient.cpf,patch);

    clearDraft();
    setBox("#msg","Formulário enviado. Voltando ao portal…","ok");
    setTimeout(goPortalWithToken,1100);

  }catch(err){
    console.error(err);
    setBox("#msg", err.message || "Falha ao enviar. Tente novamente.", "err");
    sending=false; btn.disabled=false; btn.textContent=t;
  }
});
</script>

</body>
</html>
